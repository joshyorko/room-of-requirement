# Build and publish the Room of Requirement pre-built DevContainer image
# Implements US4 - Secure Supply Chain Verification
# Tasks: T044-T049

name: Build Image

on:
  push:
    branches: [main]
    paths:
      - ".devcontainer/**"
      - "src/**"
      - ".github/workflows/build-image.yml"
  pull_request:
    branches: [main]
    paths:
      - ".devcontainer/**"
      - "src/**"
      - ".github/workflows/build-image.yml"
  workflow_run:
    workflows: ["Build Features"]
    types: [completed]
    branches: [main]
  schedule:
    # Monthly stable release - first day of month at 00:00 UTC
    - cron: "0 0 1 * *"
  workflow_call:
    inputs:
      push:
        description: "Push image to registry"
        type: boolean
        default: true
      platforms:
        description: "Target platforms (comma-separated)"
        type: string
        default: "linux/amd64"
      tags:
        description: "Additional tags (comma-separated)"
        type: string
        default: ""
      sign:
        description: "Sign image with Cosign"
        type: boolean
        default: true
      generate_sbom:
        description: "Generate and attach SBOM"
        type: boolean
        default: true
      scan_cve:
        description: "Run CVE vulnerability scan"
        type: boolean
        default: true
      fail_on_critical:
        description: "Fail build on Critical CVEs with fixes"
        type: boolean
        default: true
  workflow_dispatch:
    inputs:
      push:
        description: "Push image to registry"
        type: boolean
        default: false
      platforms:
        description: "Target platforms (comma-separated)"
        type: string
        default: "linux/amd64"
      tags:
        description: "Additional tags (comma-separated)"
        type: string
        default: ""
      sign:
        description: "Sign image with Cosign"
        type: boolean
        default: true
      generate_sbom:
        description: "Generate and attach SBOM"
        type: boolean
        default: true
      scan_cve:
        description: "Run CVE vulnerability scan"
        type: boolean
        default: true
      fail_on_critical:
        description: "Fail build on Critical CVEs with fixes"
        type: boolean
        default: true

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}/ror

permissions:
  contents: read
  packages: write
  id-token: write # Required for keyless signing with Cosign
  attestations: write # Required for SBOM attestations
  security-events: write # Required for SARIF upload

jobs:
  lint:
    name: Lint Dockerfile
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v5.0.1

      - name: Run hadolint
        uses: hadolint/hadolint-action@v3.3.0
        with:
          dockerfile: .devcontainer/Dockerfile
          failure-threshold: error
          format: sarif
          output-file: hadolint.sarif
          no-fail: false

      - name: Upload hadolint SARIF
        if: always()
        uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: hadolint.sarif
          category: hadolint

  build:
    name: Build and Push Image
    runs-on: ubuntu-latest
    needs: lint
    outputs:
      digest: ${{ steps.build.outputs.digest }}
      tags: ${{ steps.meta.outputs.tags }}
      version: ${{ steps.meta.outputs.version }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v5.0.1

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install devcontainer CLI
        run: npm install -g @devcontainers/cli

      - name: Log in to Container Registry
        uses: docker/login-action@v3.6.0
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata for Docker
        id: meta
        uses: docker/metadata-action@v5.10.0
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            # Set latest tag for main branch
            type=raw,value=latest,enable={{is_default_branch}}
            # Set stable tag for scheduled builds (monthly)
            type=raw,value=stable,enable=${{ github.event_name == 'schedule' }}
            # Semantic version tags (v1.0.0)
            type=semver,pattern=v{{version}}
            type=semver,pattern=v{{major}}.{{minor}}
            type=semver,pattern=v{{major}}
            # Git SHA tag
            type=sha,prefix=sha-,format=short
            # Branch name for non-main branches
            type=ref,event=branch
            # PR number
            type=ref,event=pr
            # Custom tags from workflow dispatch
            type=raw,value=${{ inputs.tags }},enable=${{ inputs.tags != '' }}

      - name: Build image with devcontainer CLI
        id: devcontainer-build
        if: github.event_name != 'pull_request'
        run: |
          # Build with devcontainer CLI to properly process features
          # Skipped on PRs because features aren't published yet
          IMAGE_NAME="${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:build-${{ github.run_id }}"

          devcontainer build \
            --workspace-folder . \
            --image-name "$IMAGE_NAME" \
            --platform "${{ inputs.platforms || 'linux/amd64' }}"

          echo "built_image=${IMAGE_NAME}" >> $GITHUB_OUTPUT

          # Get the digest
          DIGEST=$(docker inspect --format='{{index .RepoDigests 0}}' "$IMAGE_NAME" 2>/dev/null | cut -d'@' -f2 || echo "")
          echo "digest=${DIGEST}" >> $GITHUB_OUTPUT

      - name: Skip build on PR
        if: github.event_name == 'pull_request'
        run: |
          echo "### Image Build Skipped" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Image build skipped on PRs - features must be published first." >> $GITHUB_STEP_SUMMARY
          echo "Image will be built after merge when features are available." >> $GITHUB_STEP_SUMMARY

      - name: Tag and push image
        id: build
        if: github.event_name != 'pull_request' && (inputs.push != false || github.event_name == 'push' || github.event_name == 'schedule' || github.event_name == 'workflow_run')
        run: |
          BUILT_IMAGE="${{ steps.devcontainer-build.outputs.built_image }}"
          TAGS="${{ steps.meta.outputs.tags }}"

          # Tag with all metadata tags
          for tag in $TAGS; do
            echo "Tagging: $tag"
            docker tag "$BUILT_IMAGE" "$tag"
          done

          # Push all tags and capture digest from first push
          DIGEST=""
          for tag in $TAGS; do
            echo "Pushing: $tag"
            PUSH_OUTPUT=$(docker push "$tag" 2>&1)
            echo "$PUSH_OUTPUT"
            # Capture digest from first push (all tags have same digest)
            if [ -z "$DIGEST" ]; then
              DIGEST=$(echo "$PUSH_OUTPUT" | grep -oP 'digest: \Ksha256:[a-f0-9]+' | head -1)
            fi
          done

          echo "Captured digest: $DIGEST"
          echo "digest=${DIGEST}" >> $GITHUB_OUTPUT

      - name: Output image info
        run: |
          echo "### Image Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Digest:** \`${{ steps.build.outputs.digest }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Tags:**" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "${{ steps.meta.outputs.tags }}" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY

  sign:
    name: Sign Image with Cosign
    runs-on: ubuntu-latest
    needs: build
    if: github.event_name != 'pull_request' && needs.build.outputs.digest != ''

    steps:
      - name: Install Cosign
        uses: sigstore/cosign-installer@v3.10.1

      - name: Log in to Container Registry
        uses: docker/login-action@v3.6.0
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Sign image with Cosign (keyless)
        env:
          DIGEST: ${{ needs.build.outputs.digest }}
          TAGS: ${{ needs.build.outputs.tags }}
        run: |
          # Sign by digest to ensure immutability
          images=""
          for tag in ${TAGS}; do
            images+="${tag}@${DIGEST} "
          done

          echo "Signing images: ${images}"
          cosign sign --yes ${images}

          echo "### Cosign Signing Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Image signed with keyless OIDC identity:" >> $GITHUB_STEP_SUMMARY
          echo "- **Issuer:** https://token.actions.githubusercontent.com" >> $GITHUB_STEP_SUMMARY
          echo "- **Identity:** https://github.com/${{ github.repository }}/*" >> $GITHUB_STEP_SUMMARY

  sbom:
    name: Generate SBOM
    runs-on: ubuntu-latest
    needs: build
    if: github.event_name != 'pull_request' && needs.build.outputs.digest != ''
    outputs:
      sbom_digest: ${{ steps.attach.outputs.sbom_digest }}

    steps:
      - name: Install Cosign
        uses: sigstore/cosign-installer@v3.10.1

      - name: Log in to Container Registry
        uses: docker/login-action@v3.6.0
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Generate SBOM with Syft
        uses: anchore/sbom-action@v0.21.0
        id: sbom
        with:
          image: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}@${{ needs.build.outputs.digest }}
          format: spdx-json
          output-file: sbom.spdx.json
          upload-artifact: true
          artifact-name: sbom-spdx

      - name: Attach SBOM attestation
        id: attach
        env:
          DIGEST: ${{ needs.build.outputs.digest }}
        run: |
          # Attach SBOM as attestation using cosign attest
          cosign attest --yes \
            --predicate sbom.spdx.json \
            --type spdxjson \
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}@${DIGEST}

          # Calculate SBOM digest for reference
          SBOM_DIGEST=$(sha256sum sbom.spdx.json | cut -d' ' -f1)
          echo "sbom_digest=${SBOM_DIGEST}" >> $GITHUB_OUTPUT

          echo "### SBOM Generated" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Format:** SPDX JSON" >> $GITHUB_STEP_SUMMARY
          echo "**SBOM Digest:** \`${SBOM_DIGEST}\`" >> $GITHUB_STEP_SUMMARY

  scan:
    name: CVE Vulnerability Scan
    runs-on: ubuntu-latest
    needs: build
    if: github.event_name != 'pull_request' && needs.build.outputs.digest != ''
    outputs:
      critical: ${{ steps.scan.outputs.critical }}
      high: ${{ steps.scan.outputs.high }}
      medium: ${{ steps.scan.outputs.medium }}
      low: ${{ steps.scan.outputs.low }}

    steps:
      - name: Scan for vulnerabilities with Grype
        uses: anchore/scan-action@v3.6.4
        id: grype
        with:
          image: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}@${{ needs.build.outputs.digest }}
          fail-build: ${{ inputs.fail_on_critical != false }}
          severity-cutoff: critical
          output-format: sarif
        continue-on-error: true

      - name: Upload SARIF report
        if: always()
        uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: ${{ steps.grype.outputs.sarif }}

      - name: Parse scan results
        id: scan
        run: |
          # Parse Grype JSON output for counts
          # Note: Using jq to extract vulnerability counts
          if [ -f results.json ]; then
            CRITICAL=$(jq '[.matches[] | select(.vulnerability.severity == "Critical")] | length' results.json 2>/dev/null || echo "0")
            HIGH=$(jq '[.matches[] | select(.vulnerability.severity == "High")] | length' results.json 2>/dev/null || echo "0")
            MEDIUM=$(jq '[.matches[] | select(.vulnerability.severity == "Medium")] | length' results.json 2>/dev/null || echo "0")
            LOW=$(jq '[.matches[] | select(.vulnerability.severity == "Low")] | length' results.json 2>/dev/null || echo "0")
          else
            CRITICAL=0
            HIGH=0
            MEDIUM=0
            LOW=0
          fi

          echo "critical=${CRITICAL}" >> $GITHUB_OUTPUT
          echo "high=${HIGH}" >> $GITHUB_OUTPUT
          echo "medium=${MEDIUM}" >> $GITHUB_OUTPUT
          echo "low=${LOW}" >> $GITHUB_OUTPUT

          echo "### Vulnerability Scan Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Severity | Count |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Critical | ${CRITICAL} |" >> $GITHUB_STEP_SUMMARY
          echo "| High | ${HIGH} |" >> $GITHUB_STEP_SUMMARY
          echo "| Medium | ${MEDIUM} |" >> $GITHUB_STEP_SUMMARY
          echo "| Low | ${LOW} |" >> $GITHUB_STEP_SUMMARY

      - name: Check for critical vulnerabilities
        if: inputs.fail_on_critical != false && steps.grype.outcome == 'failure'
        run: |
          echo "::error::Critical vulnerabilities found with available fixes. Build failed."
          exit 1

  provenance:
    name: Generate SLSA Provenance
    needs: [build, sign]
    if: github.event_name != 'pull_request'
    permissions:
      actions: read
      id-token: write
      packages: write
    uses: slsa-framework/slsa-github-generator/.github/workflows/generator_container_slsa3.yml@v2.0.0
    with:
      image: ghcr.io/${{ github.repository }}/ror
      digest: ${{ needs.build.outputs.digest }}
      registry-username: ${{ github.actor }}
    secrets:
      registry-password: ${{ secrets.GITHUB_TOKEN }}

  summary:
    name: Build Summary
    runs-on: ubuntu-latest
    needs: [build, sign, sbom, scan, provenance]
    if: always()

    steps:
      - name: Generate summary
        run: |
          echo "# Room of Requirement Image Build" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Status" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Build | ${{ needs.build.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Sign | ${{ needs.sign.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| SBOM | ${{ needs.sbom.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| CVE Scan | ${{ needs.scan.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Provenance | ${{ needs.provenance.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Verification Commands" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
          echo "# Verify image signature" >> $GITHUB_STEP_SUMMARY
          echo "cosign verify ghcr.io/${{ github.repository }}/ror:latest \\" >> $GITHUB_STEP_SUMMARY
          echo "  --certificate-identity-regexp=\"https://github.com/${{ github.repository }}/*\" \\" >> $GITHUB_STEP_SUMMARY
          echo "  --certificate-oidc-issuer=\"https://token.actions.githubusercontent.com\"" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "# Verify SBOM attestation" >> $GITHUB_STEP_SUMMARY
          echo "cosign verify-attestation ghcr.io/${{ github.repository }}/ror:latest \\" >> $GITHUB_STEP_SUMMARY
          echo "  --type spdxjson \\" >> $GITHUB_STEP_SUMMARY
          echo "  --certificate-identity-regexp=\"https://github.com/${{ github.repository }}/*\" \\" >> $GITHUB_STEP_SUMMARY
          echo "  --certificate-oidc-issuer=\"https://token.actions.githubusercontent.com\"" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
