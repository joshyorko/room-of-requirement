# Build and publish DevContainer Features
# Implements US4 - Secure Supply Chain Verification
# Tasks: T050-T051

name: Build Features

on:
  push:
    branches: [main]
    paths:
      - "src/**"
      - ".github/workflows/build-features.yml"
  pull_request:
    branches: [main]
    paths:
      - "src/**"
      - ".github/workflows/build-features.yml"
  workflow_call:
    inputs:
      features:
        description: "Specific features to build (comma-separated, empty = all)"
        type: string
        default: ""
      publish:
        description: "Publish features to GHCR"
        type: boolean
        default: true
      generate_docs:
        description: "Generate README files for features"
        type: boolean
        default: true
      dry_run:
        description: "Validate without building"
        type: boolean
        default: false
      sign:
        description: "Sign features with Cosign"
        type: boolean
        default: true
  workflow_dispatch:
    inputs:
      features:
        description: "Specific features to build (comma-separated, empty = all)"
        type: string
        default: ""
      publish:
        description: "Publish features to GHCR"
        type: boolean
        default: false
      generate_docs:
        description: "Generate README files for features"
        type: boolean
        default: true
      dry_run:
        description: "Validate without building"
        type: boolean
        default: false
      sign:
        description: "Sign features with Cosign"
        type: boolean
        default: true

env:
  REGISTRY: ghcr.io
  FEATURES_NAMESPACE: joshyorko/devcontainer-features

permissions:
  contents: write  # Required for committing lockfile updates
  packages: write
  id-token: write  # Required for keyless signing with Cosign

jobs:
  detect-features:
    name: Detect Changed Features
    runs-on: ubuntu-latest
    outputs:
      features: ${{ steps.detect.outputs.features }}
      matrix: ${{ steps.detect.outputs.matrix }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v5.0.1
        with:
          fetch-depth: 0

      - name: Detect features to build
        id: detect
        run: |
          # If specific features are provided, use those
          if [ -n "${{ inputs.features }}" ]; then
            FEATURES="${{ inputs.features }}"
          # For PRs and pushes, detect changed features
          elif [ "${{ github.event_name }}" = "pull_request" ]; then
            FEATURES=$(git diff --name-only ${{ github.event.pull_request.base.sha }} ${{ github.sha }} | \
              grep '^src/' | \
              cut -d'/' -f2 | \
              sort -u | \
              tr '\n' ',' | \
              sed 's/,$//')
          elif [ "${{ github.event_name }}" = "push" ]; then
            FEATURES=$(git diff --name-only ${{ github.event.before }} ${{ github.sha }} | \
              grep '^src/' | \
              cut -d'/' -f2 | \
              sort -u | \
              tr '\n' ',' | \
              sed 's/,$//')
          # For workflow dispatch without specific features, build all
          else
            FEATURES=$(ls -d src/*/ 2>/dev/null | xargs -n1 basename | tr '\n' ',' | sed 's/,$//')
          fi

          # If no features detected, default to all
          if [ -z "$FEATURES" ]; then
            FEATURES=$(ls -d src/*/ 2>/dev/null | xargs -n1 basename | tr '\n' ',' | sed 's/,$//')
          fi

          echo "features=${FEATURES}" >> $GITHUB_OUTPUT

          # Create matrix JSON for parallel builds
          MATRIX_JSON=$(echo "$FEATURES" | tr ',' '\n' | jq -R -s -c 'split("\n") | map(select(length > 0))')
          echo "matrix=${MATRIX_JSON}" >> $GITHUB_OUTPUT

          echo "### Features to Build" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "$FEATURES" | tr ',' '\n' | while read feature; do
            echo "- \`${feature}\`" >> $GITHUB_STEP_SUMMARY
          done

  validate:
    name: Validate Features
    runs-on: ubuntu-latest
    needs: detect-features
    if: needs.detect-features.outputs.features != ''

    steps:
      - name: Checkout repository
        uses: actions/checkout@v5.0.1

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install devcontainer CLI
        run: npm install -g @devcontainers/cli

      - name: Validate feature manifests
        run: |
          echo "### Feature Validation" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          FEATURES="${{ needs.detect-features.outputs.features }}"
          FAILED=0

          for feature in $(echo "$FEATURES" | tr ',' ' '); do
            echo "Validating feature: ${feature}"

            MANIFEST="src/${feature}/devcontainer-feature.json"
            INSTALL="src/${feature}/install.sh"

            # Check manifest exists and is valid JSON
            if [ ! -f "$MANIFEST" ]; then
              echo "::error::Missing manifest for feature ${feature}"
              echo "- âŒ \`${feature}\`: Missing devcontainer-feature.json" >> $GITHUB_STEP_SUMMARY
              FAILED=1
              continue
            fi

            if ! jq empty "$MANIFEST" 2>/dev/null; then
              echo "::error::Invalid JSON in manifest for feature ${feature}"
              echo "- âŒ \`${feature}\`: Invalid JSON in manifest" >> $GITHUB_STEP_SUMMARY
              FAILED=1
              continue
            fi

            # Check install.sh exists and is executable
            if [ ! -f "$INSTALL" ]; then
              echo "::error::Missing install.sh for feature ${feature}"
              echo "- âŒ \`${feature}\`: Missing install.sh" >> $GITHUB_STEP_SUMMARY
              FAILED=1
              continue
            fi

            # Validate required fields in manifest
            ID=$(jq -r '.id' "$MANIFEST")
            VERSION=$(jq -r '.version' "$MANIFEST")

            if [ "$ID" = "null" ] || [ -z "$ID" ]; then
              echo "::error::Missing 'id' field in manifest for feature ${feature}"
              echo "- âŒ \`${feature}\`: Missing 'id' field" >> $GITHUB_STEP_SUMMARY
              FAILED=1
              continue
            fi

            if [ "$VERSION" = "null" ] || [ -z "$VERSION" ]; then
              echo "::error::Missing 'version' field in manifest for feature ${feature}"
              echo "- âŒ \`${feature}\`: Missing 'version' field" >> $GITHUB_STEP_SUMMARY
              FAILED=1
              continue
            fi

            echo "- âœ… \`${feature}\` (v${VERSION})" >> $GITHUB_STEP_SUMMARY
          done

          if [ $FAILED -ne 0 ]; then
            echo "::error::Feature validation failed"
            exit 1
          fi

  build:
    name: Build Features
    runs-on: ubuntu-latest
    needs: [detect-features, validate]
    if: needs.detect-features.outputs.features != '' && inputs.dry_run != true
    outputs:
      published: ${{ steps.publish.outputs.published }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v5.0.1

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install devcontainer CLI
        run: npm install -g @devcontainers/cli

      - name: Log in to Container Registry
        if: github.event_name != 'pull_request'
        uses: docker/login-action@v3.6.0
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Generate feature documentation
        if: inputs.generate_docs != false
        run: |
          # Generate README.md for each feature from manifest
          FEATURES="${{ needs.detect-features.outputs.features }}"

          for feature in $(echo "$FEATURES" | tr ',' ' '); do
            MANIFEST="src/${feature}/devcontainer-feature.json"
            README="src/${feature}/README.md"

            NAME=$(jq -r '.name' "$MANIFEST")
            DESC=$(jq -r '.description // "No description provided"' "$MANIFEST")
            VERSION=$(jq -r '.version' "$MANIFEST")
            DOC_URL=$(jq -r '.documentationURL // ""' "$MANIFEST")

            cat > "$README" << EOF
          # ${NAME}

          ${DESC}

          ## Usage

          \`\`\`json
          {
            "features": {
              "ghcr.io/${{ env.FEATURES_NAMESPACE }}/${feature}:${VERSION}": {}
            }
          }
          \`\`\`

          ## Options

          $(jq -r '.options // {} | to_entries | map("| \(.key) | \(.value.type // "string") | \(.value.default // "N/A") | \(.value.description // "No description") |") | ["| Option | Type | Default | Description |", "|--------|------|---------|-------------|"] + . | .[]' "$MANIFEST")

          ---

          *Auto-generated from devcontainer-feature.json*
          EOF

            if [ -n "$DOC_URL" ] && [ "$DOC_URL" != "null" ]; then
              echo "" >> "$README"
              echo "## Documentation" >> "$README"
              echo "" >> "$README"
              echo "See [${DOC_URL}](${DOC_URL}) for more information." >> "$README"
            fi
          done

      - name: Build and publish features
        id: publish
        env:
          PUBLISH: ${{ github.event_name != 'pull_request' && (inputs.publish || github.event_name == 'push') }}
        run: |
          FEATURES="${{ needs.detect-features.outputs.features }}"
          PUBLISHED_JSON="[]"

          echo "### Feature Build Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          for feature in $(echo "$FEATURES" | tr ',' ' '); do
            echo "Building feature: ${feature}"

            VERSION=$(jq -r '.version' "src/${feature}/devcontainer-feature.json")

            if [ "$PUBLISH" = "true" ]; then
              # Build and publish with devcontainer CLI
              devcontainer features publish \
                --registry ${{ env.REGISTRY }} \
                --namespace ${{ env.FEATURES_NAMESPACE }} \
                "src/${feature}"

              FEATURE_URI="${{ env.REGISTRY }}/${{ env.FEATURES_NAMESPACE }}/${feature}:${VERSION}"

              # Add to published list
              PUBLISHED_JSON=$(echo "$PUBLISHED_JSON" | jq --arg id "$feature" --arg version "$VERSION" --arg uri "$FEATURE_URI" \
                '. + [{"id": $id, "version": $version, "uri": $uri}]')

              echo "- âœ… \`${feature}\` published as \`${FEATURE_URI}\`" >> $GITHUB_STEP_SUMMARY
            else
              # Build only (validation)
              devcontainer features package \
                "src/${feature}" \
                --output-folder ./output \
                -f

              echo "- ðŸ“¦ \`${feature}\` built (not published)" >> $GITHUB_STEP_SUMMARY
            fi
          done

          echo "published=${PUBLISHED_JSON}" >> $GITHUB_OUTPUT

      - name: Upload build artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: feature-builds
          path: output/
          if-no-files-found: ignore

  sign:
    name: Sign and Annotate Features
    runs-on: ubuntu-latest
    needs: [detect-features, build]
    if: github.event_name != 'pull_request' && inputs.sign != false && needs.build.outputs.published != '[]'

    steps:
      - name: Install Cosign
        uses: sigstore/cosign-installer@v3.10.1

      - name: Install crane
        uses: imjasonh/setup-crane@v0.3

      - name: Install ORAS
        uses: oras-project/setup-oras@v1

      - name: Log in to Container Registry
        uses: docker/login-action@v3.6.0
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Sign published features
        run: |
          PUBLISHED='${{ needs.build.outputs.published }}'

          echo "### Feature Signing" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "$PUBLISHED" | jq -c '.[]' | while read -r feature; do
            URI=$(echo "$feature" | jq -r '.uri')
            ID=$(echo "$feature" | jq -r '.id')

            echo "Signing feature: ${URI}"

            # Get the digest for the feature
            DIGEST=$(crane digest "$URI" 2>/dev/null || echo "")

            if [ -n "$DIGEST" ]; then
              # Sign the feature OCI artifact
              cosign sign --yes "${URI%:*}@${DIGEST}"
              echo "- âœ… \`${ID}\` signed" >> $GITHUB_STEP_SUMMARY
            else
              echo "::warning::Could not get digest for ${URI}"
              echo "- âš ï¸ \`${ID}\` signing skipped (no digest)" >> $GITHUB_STEP_SUMMARY
            fi
          done

      - name: Add OCI source annotations
        env:
          SOURCE_URL: https://github.com/${{ github.repository }}
        run: |
          PUBLISHED='${{ needs.build.outputs.published }}'

          echo "### OCI Annotations" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "$PUBLISHED" | jq -c '.[]' | while read -r feature; do
            URI=$(echo "$feature" | jq -r '.uri')
            ID=$(echo "$feature" | jq -r '.id')

            echo "Adding source annotation to: ${URI}"

            # Add org.opencontainers.image.source annotation to link package to repo
            if oras manifest annotate "$URI" \
              org.opencontainers.image.source="${SOURCE_URL}" 2>/dev/null; then
              echo "- âœ… \`${ID}\` annotated with source" >> $GITHUB_STEP_SUMMARY
            else
              echo "::warning::Could not annotate ${URI}"
              echo "- âš ï¸ \`${ID}\` annotation skipped" >> $GITHUB_STEP_SUMMARY
            fi
          done

  update-lockfile:
    name: Update Lockfile
    runs-on: ubuntu-latest
    needs: [build, sign]
    if: github.event_name != 'pull_request' && needs.build.outputs.published != '[]'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v5.0.1
        with:
          ref: ${{ github.ref }}
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install devcontainer CLI
        run: npm install -g @devcontainers/cli

      - name: Update devcontainer lockfile
        id: upgrade
        run: |
          echo "Running devcontainer upgrade to refresh lockfile..."
          devcontainer upgrade --workspace-folder .

          # Check if lockfile changed
          if git diff --quiet .devcontainer/devcontainer-lock.json 2>/dev/null; then
            echo "changed=false" >> $GITHUB_OUTPUT
            echo "Lockfile unchanged"
          else
            echo "changed=true" >> $GITHUB_OUTPUT
            echo "Lockfile updated with new feature SHAs"
            git diff .devcontainer/devcontainer-lock.json
          fi

      - name: Commit lockfile update
        if: steps.upgrade.outputs.changed == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add .devcontainer/devcontainer-lock.json
          git commit -m "chore: Update devcontainer-lock.json with new feature SHAs

          Auto-generated after feature publish.

          ðŸ¤– Generated by Build Features workflow"

          git push

          echo "### Lockfile Updated" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Committed updated \`devcontainer-lock.json\` with new feature digests." >> $GITHUB_STEP_SUMMARY

      - name: Lockfile unchanged
        if: steps.upgrade.outputs.changed != 'true'
        run: |
          echo "### Lockfile Unchanged" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "No changes to \`devcontainer-lock.json\` after feature publish." >> $GITHUB_STEP_SUMMARY

  summary:
    name: Build Summary
    runs-on: ubuntu-latest
    needs: [detect-features, validate, build, sign, update-lockfile]
    if: always()

    steps:
      - name: Generate summary
        run: |
          echo "# DevContainer Features Build" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Status" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Detect | ${{ needs.detect-features.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Validate | ${{ needs.validate.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Build | ${{ needs.build.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Sign & Annotate | ${{ needs.sign.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Update Lockfile | ${{ needs.update-lockfile.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Usage" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Add features to your devcontainer.json:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`json" >> $GITHUB_STEP_SUMMARY
          echo '{' >> $GITHUB_STEP_SUMMARY
          echo '  "features": {' >> $GITHUB_STEP_SUMMARY
          echo '    "ghcr.io/${{ env.FEATURES_NAMESPACE }}/mise:1": {},' >> $GITHUB_STEP_SUMMARY
          echo '    "ghcr.io/${{ env.FEATURES_NAMESPACE }}/starship:1": {}' >> $GITHUB_STEP_SUMMARY
          echo '  }' >> $GITHUB_STEP_SUMMARY
          echo '}' >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
