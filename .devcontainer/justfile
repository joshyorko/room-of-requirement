# Room of Requirement DevContainer Commands
# Usage: just <command> (or ujust <command>)

# Default recipe - show available commands
default:
    @just --list

# Install applications from curated Brewfiles
bbrew:
    #!/usr/bin/env bash
    BREW_DIR="${BREW_DIR:-/usr/share/ror/brew}"
    # Fallback chain for development/edge cases
    if [ ! -d "$BREW_DIR" ]; then
        # Try workspace-relative path
        for ws in /workspaces/*/; do
            if [ -d "${ws}.devcontainer/brew" ]; then
                BREW_DIR="${ws}.devcontainer/brew"
                break
            fi
        done
    fi
    if ! command -v gum &>/dev/null; then
        echo "Installing gum..."
        brew install gum
    fi
    if ! command -v bbrew &>/dev/null; then
        echo "Installing Bold Brew (bbrew)..."
        brew tap valkyrie00/bbrew
        brew install valkyrie00/bbrew/bbrew
    fi
    bbrew -f "${BREW_DIR}/$(gum choose $(find "${BREW_DIR}"/*.Brewfile -exec basename '{}' '.Brewfile' ';')).Brewfile"

# Install bbrew TUI only (minimal setup)
install-bbrew:
    @echo "Installing bbrew (Bold Brew TUI)..."
    brew tap valkyrie00/bbrew
    brew install valkyrie00/bbrew/bbrew
    @echo "Done! Run 'ujust bbrew' to launch the TUI."

# Install all Homebrew packages from all Brewfiles (full setup)
brew-install-all:
    #!/usr/bin/env bash
    echo "Installing ALL Homebrew packages from all Brewfiles..."
    echo "This may take a while..."
    BREW_DIR="${BREW_DIR:-/usr/share/ror/brew}"
    # Fallback chain for development/edge cases
    if [ ! -d "$BREW_DIR" ]; then
        for ws in /workspaces/*/; do
            if [ -d "${ws}.devcontainer/brew" ]; then
                BREW_DIR="${ws}.devcontainer/brew"
                break
            fi
        done
    fi
    for brewfile in "$BREW_DIR"/*.Brewfile; do
        echo "Installing from $(basename "$brewfile")..."
        brew bundle install --file="$brewfile" || true
    done
    echo "Done! Run 'ujust bbrew' for the TUI or 'brew list' to see packages."

# Install specific brew formula
brew-install formula:
    brew install {{formula}}

# Update Homebrew and upgrade packages
brew-update:
    brew update && brew upgrade

# Enable Ruby tooling on demand via mise (recommended)
ruby-enable ruby_version='latest':
    #!/usr/bin/env bash
    set -euo pipefail
    if ! command -v mise &>/dev/null; then
        echo "mise not found in PATH" >&2
        exit 1
    fi
    eval "$(mise activate bash)"
    echo "Installing Ruby with mise: ruby@{{ruby_version}}"
    mise use -g ruby@{{ruby_version}}
    mise reshim
    echo "Ruby ready: $(mise exec -- ruby --version)"
    echo "Bundler: $(mise exec -- bundle --version)"

# Enable Rails on demand via mise-managed Ruby
rails-enable ruby_version='latest' rails_version='latest':
    #!/usr/bin/env bash
    set -euo pipefail
    if ! command -v mise &>/dev/null; then
        echo "mise not found in PATH" >&2
        exit 1
    fi
    eval "$(mise activate bash)"
    echo "Installing Ruby with mise: ruby@{{ruby_version}}"
    mise use -g ruby@{{ruby_version}}
    if [ "{{rails_version}}" = "latest" ]; then
        echo "Installing latest Rails gem"
        mise exec -- gem install rails
    else
        echo "Installing Rails gem version {{rails_version}}"
        mise exec -- gem install rails -v "{{rails_version}}"
    fi
    mise reshim
    echo "Ruby: $(mise exec -- ruby --version)"
    echo "Rails: $(mise exec -- rails --version)"

# Show Docker status
docker-status:
    @docker info 2>/dev/null && echo "Docker is running" || echo "Docker is not running"

# Start Docker daemon (if not running)
docker-start:
    @if ! docker info >/dev/null 2>&1; then \
        echo "Starting Docker daemon..."; \
        sudo /usr/bin/dockerd-entrypoint.sh dockerd &; \
        sleep 3; \
    else \
        echo "Docker is already running"; \
    fi

# Clean up Docker resources
docker-clean:
    docker system prune -af

# Show system info
info:
    @echo "=== Room of Requirement DevContainer ==="
    @echo "OS: $(cat /etc/os-release | grep PRETTY_NAME | cut -d= -f2)"
    @echo "Shell: $SHELL"
    @echo "Homebrew: $(brew --version | head -1)"
    @echo "Docker: $(docker --version 2>/dev/null || echo 'not running')"
    @echo "Just: $(just --version)"
