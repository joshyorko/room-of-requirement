# Room of Requirement DevContainer Commands
# Usage: just <command> (or ujust <command>)

# Default recipe - show available commands
default:
    @just --list

# Install applications from curated Brewfiles
bbrew:
    #!/usr/bin/env bash
    BREW_DIR="${BREW_DIR:-/tmp/brew}"
    # Fallback to .devcontainer/brew if running from workspace
    if [ ! -d "$BREW_DIR" ] && [ -d ".devcontainer/brew" ]; then
        BREW_DIR=".devcontainer/brew"
    fi
    if ! command -v gum &>/dev/null; then
        echo "Installing gum..."
        brew install gum
    fi
    if ! command -v bbrew &>/dev/null; then
        if gum confirm "Bold Brew is not installed, would you like to install it?"; then
            brew install Valkyrie00/homebrew-bbrew/bbrew
        else
            exit 0
        fi
    fi
    bbrew -f "${BREW_DIR}/$(gum choose $(find "${BREW_DIR}"/*.Brewfile -exec basename '{}' '.Brewfile' ';')).Brewfile"

# Install bbrew TUI only (minimal setup)
install-bbrew:
    @echo "Installing bbrew (Bold Brew TUI)..."
    brew tap valkyrie00/bbrew
    brew install valkyrie00/bbrew/bbrew
    @echo "Done! Run 'ujust bbrew' to launch the TUI."

# Install all Homebrew packages from all Brewfiles (full setup)
brew-install-all:
    #!/usr/bin/env bash
    echo "Installing ALL Homebrew packages from all Brewfiles..."
    echo "This may take a while..."
    BREW_DIR="${BREW_DIR:-/tmp/brew}"
    if [ ! -d "$BREW_DIR" ] && [ -d ".devcontainer/brew" ]; then
        BREW_DIR=".devcontainer/brew"
    fi
    for brewfile in "$BREW_DIR"/*.Brewfile; do
        echo "Installing from $(basename "$brewfile")..."
        brew bundle install --file="$brewfile" || true
    done
    echo "Done! Run 'ujust bbrew' for the TUI or 'brew list' to see packages."

# Install specific brew formula
brew-install formula:
    brew install {{formula}}

# Update Homebrew and upgrade packages
brew-update:
    brew update && brew upgrade

# Show Docker status
docker-status:
    @docker info 2>/dev/null && echo "Docker is running" || echo "Docker is not running"

# Start Docker daemon (if not running)
docker-start:
    @if ! docker info >/dev/null 2>&1; then \
        echo "Starting Docker daemon..."; \
        sudo /usr/bin/dockerd-entrypoint.sh dockerd &; \
        sleep 3; \
    else \
        echo "Docker is already running"; \
    fi

# Clean up Docker resources
docker-clean:
    docker system prune -af

# Show system info
info:
    @echo "=== Room of Requirement DevContainer ==="
    @echo "OS: $(cat /etc/os-release | grep PRETTY_NAME | cut -d= -f2)"
    @echo "Shell: $SHELL"
    @echo "Homebrew: $(brew --version | head -1)"
    @echo "Docker: $(docker --version 2>/dev/null || echo 'not running')"
    @echo "Just: $(just --version)"

# ============================================================================
# Playwright / Browser Automation
# ============================================================================

# Install Playwright browsers (Chromium, Firefox, WebKit)
playwright-install:
    #!/usr/bin/env bash
    set -euo pipefail
    echo "Installing Playwright browsers..."
    if command -v npx &>/dev/null; then
        npx playwright install
        echo "✓ Playwright browsers installed"
    else
        echo "✗ npx not found. Install Node.js first (mise install node@lts)"
        exit 1
    fi

# Install Playwright with system dependencies check
playwright-setup:
    #!/usr/bin/env bash
    set -euo pipefail
    echo "=== Playwright Setup ==="
    echo ""
    echo "System browser dependencies are pre-installed in this container."
    echo "You can now install Playwright browsers:"
    echo ""
    echo "  Option 1: Install via npm/pnpm"
    echo "    npm install -D @playwright/test"
    echo "    npx playwright install"
    echo ""
    echo "  Option 2: Install via uv (Python)"
    echo "    uv pip install playwright"
    echo "    playwright install"
    echo ""
    echo "  Option 3: Use ujust"
    echo "    ujust playwright-install"
    echo ""
    echo "Browser dependencies status:"
    for lib in libgtk-3.so libnss3.so libnspr4.so libdrm.so libgbm.so; do
        if ldconfig -p 2>/dev/null | grep -q "$lib" || find /usr/lib -name "$lib*" 2>/dev/null | head -1 | grep -q .; then
            echo "  ✓ $lib"
        else
            echo "  ? $lib (may be available)"
        fi
    done
